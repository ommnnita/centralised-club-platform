{% extends "base.html" %}

{% block title %}Manage Club - Campus Connect{% endblock %}

{% block content %}
<div style="display: flex; gap: 2rem; flex-wrap: wrap;">
    
    <div class="card" style="flex: 1; min-width: 300px;">
        <h2>Create New Event</h2>
        <form id="createEventForm">
            <div style="margin-bottom: 1rem;">
                <label>Event Title</label>
                <input type="text" id="title" required style="width: 100%; padding: 0.5rem;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label>Date & Time</label>
                <input type="datetime-local" id="event_time" required style="width: 100%; padding: 0.5rem;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label>Visibility</label>
                <select id="is_public" style="width: 100%; padding: 0.5rem;">
                    <option value="false">Internal (Members Only)</option>
                    <option value="true">Public (Everyone)</option>
                </select>
            </div>

            <button type="submit" class="btn">Create Event</button>
        </form>
    </div>

    <div class="card" style="flex: 1; min-width: 300px;">
        <h2>Events & QR Codes</h2>
        <div id="events-list">Loading events...</div>
    </div>
</div>

<div id="qrModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); text-align:center; padding-top:100px;">
    <div style="background:white; padding:2rem; display:inline-block; border-radius:8px;">
        <h3>Scan to Attend</h3>
        <img id="qrImage" src="" alt="QR Code" style="width: 250px; height: 250px; display: block; margin: 0 auto;">
        <br>
        <button class="btn" onclick="document.getElementById('qrModal').style.display='none'">Close</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // 1. Get Club ID from the URL (Passed by FastAPI)
    const CLUB_ID = "{{ club_id }}"; 
    const token = localStorage.getItem("access_token");

    // --- LOAD EVENTS ---
    async function loadEvents() {
        const response = await fetch(`/clubs/${CLUB_ID}/activities`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        const events = await response.json();
        const container = document.getElementById("events-list");
        container.innerHTML = "";

        events.forEach(event => {
            const div = document.createElement("div");
            div.style.borderBottom = "1px solid #eee";
            div.style.padding = "1rem 0";
            div.innerHTML = `
                <strong>${event.title}</strong><br>
                <small>${new Date(event.event_time).toLocaleString()}</small><br>
                <button class="btn" style="margin-top:0.5rem; font-size:0.8rem;" onclick="showQR(${event.id})">
                    Show QR Code
                </button>
            `;
            container.appendChild(div);
        });
    }

    // --- CREATE EVENT ---
    document.getElementById("createEventForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const title = document.getElementById("title").value;
        const time = document.getElementById("event_time").value;
        const isPublic = document.getElementById("is_public").value === "true";

        const response = await fetch(`/clubs/${CLUB_ID}/activities`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                title: title,
                event_time: time,
                is_public: isPublic,
                description: "Created via Admin Panel"
            })
        });

        if (response.ok) {
            alert("Event Created!");
            loadEvents(); // Refresh the list
        } else {
            alert("Failed. Are you the Admin?");
        }
    });

    // --- SHOW QR (The Streaming Response) ---
    function showQR(activityId) {
        const modal = document.getElementById("qrModal");
        const img = document.getElementById("qrImage");
        
        // We set the Image Source to the Backend URL
        // The browser fetches the image bytes automatically!
        // We add a random number (?t=...) to force the browser to not cache old QRs
        img.src = `/activities/${activityId}/qr?token=${token}`; 
        
        // Wait! We can't pass the Bearer token in the IMG SRC easily.
        // TRICK: For this MVP, we will fetch it as a blob and display it.
        fetchAndShowQR(activityId);
    }

    async function fetchAndShowQR(activityId) {
        const response = await fetch(`/activities/${activityId}/qr`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            document.getElementById("qrImage").src = url;
            document.getElementById("qrModal").style.display = "block";
        } else {
            alert("Could not load QR. Are you the Admin?");
        }
    }

    loadEvents();
</script>
{% endblock %}